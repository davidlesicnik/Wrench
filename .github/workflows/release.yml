name: Release

on:
  push:
    branches: [master]

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Verify version bump
        run: |
          if ! git tag -l | grep -q '^v'; then
            echo "No previous release tag found; skipping version check."
            exit 0
          fi
          currentName=$(grep -E 'versionName\s*=' app/build.gradle.kts | head -n1 | sed -E 's/.*"([^"]+)".*/\1/')
          currentCode=$(grep -E 'versionCode\s*=' app/build.gradle.kts | head -n1 | sed -E 's/[^0-9]//g')

          prevFile=$(git show HEAD^:app/build.gradle.kts 2>/dev/null || true)
          if [ -z "$prevFile" ]; then
            echo "No previous build.gradle.kts found; skipping version check."
            exit 0
          fi

          prevName=$(echo "$prevFile" | grep -E 'versionName\s*=' | head -n1 | sed -E 's/.*"([^"]+)".*/\1/')
          prevCode=$(echo "$prevFile" | grep -E 'versionCode\s*=' | head -n1 | sed -E 's/[^0-9]//g')

          if [ -z "$currentName" ] || [ -z "$prevName" ]; then
            echo "Could not parse versionName; failing."
            exit 1
          fi

          if [ -z "$currentCode" ] || [ -z "$prevCode" ]; then
            echo "Could not parse versionCode; failing."
            exit 1
          fi

          if [ "$currentName" = "$prevName" ]; then
            echo "versionName did not change: $currentName"
            exit 1
          fi

          if [ "$currentCode" -le "$prevCode" ]; then
            echo "versionCode did not increase: previous=$prevCode current=$currentCode"
            exit 1
          fi

          maxName=$(printf "%s\n%s\n" "$prevName" "$currentName" | sort -V | tail -n1)
          if [ "$maxName" != "$currentName" ]; then
            echo "versionName did not increase: previous=$prevName current=$currentName"
            exit 1
          fi

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Decode Keystore
        env:
          ENCODED_STRING: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
        run: |
          if [ -z "$ENCODED_STRING" ]; then
            echo "RELEASE_KEYSTORE_BASE64 is empty"
            exit 1
          fi
          printf '%s' "$ENCODED_STRING" | base64 -d > release-keystore.jks
          echo "RELEASE_KEYSTORE_PATH=$GITHUB_WORKSPACE/release-keystore.jks" >> "$GITHUB_ENV"

      - name: Build release APK
        env:
          RELEASE_KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        run: ./gradlew assembleRelease

      - name: Extract version
        id: version
        run: |
          versionName=$(grep -E 'versionName\s*=' app/build.gradle.kts | head -n1 | sed -E 's/.*"([^"]+)".*/\1/')
          echo "version_name=$versionName" >> "$GITHUB_OUTPUT"

      - name: Prepare APK artifact
        id: artifact
        run: |
          apk_dir="app/build/outputs/apk/release"
          if [ -f "$apk_dir/app-release.apk" ]; then
            apk_path="$apk_dir/app-release.apk"
          else
            apk_path=$(ls "$apk_dir"/*.apk | head -n1)
          fi
          out="wrench-v${{ steps.version.outputs.version_name }}.apk"
          cp "$apk_path" "$out"
          echo "apk=$out" >> "$GITHUB_OUTPUT"

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version_name }}
          name: Wrench v${{ steps.version.outputs.version_name }}
          draft: true
          generate_release_notes: true
          files: ${{ steps.artifact.outputs.apk }}
